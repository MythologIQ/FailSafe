name: aegis-bootstrap
version: "1.0.0"
description: Initialize QoreLogic A.E.G.I.S. DNA for a new project
phase: ALIGN + ENCODE
orbit: orbit-governor
risk_grade: L1

triggers:
  - command: "/aegis-bootstrap"
  - condition: "docs/META_LEDGER.md does not exist"

inputs:
  project_name:
    type: string
    required: false
    description: Name of the project being initialized

outputs:
  - docs/CONCEPT.md
  - docs/ARCHITECTURE_PLAN.md
  - docs/META_LEDGER.md

preconditions:
  - name: check_existing_dna
    check: "docs/META_LEDGER.md"
    expect: "not_exists"
    on_fail:
      action: abort
      message: "Integrity Violation: Genesis already exists. Use /aegis-status to resume."

steps:
  - id: activate_governor
    name: Identity Activation
    action: activate_orbit
    orbit: orbit-governor
    mode: "Zero Fluff"

  - id: create_directories
    name: Create Directory Structure
    action: ensure_directories
    paths:
      - ".agent/"
      - ".agent/staging/"
      - "docs/"

  - id: gather_concept
    name: ALIGN - Gather Strategic Intent
    action: prompt_user
    prompts:
      - question: "What is the ONE-SENTENCE purpose of this project/feature?"
        variable: why_statement
        validation: "Must be a single sentence"
        on_fail: "If you cannot explain it in one sentence, the scope is too large."
      - question: "What are THREE keywords that capture the design philosophy (Vibe)?"
        variable: vibe_keywords
        format: "comma-separated"
      - question: "What should this project explicitly NOT do (Anti-Goals)?"
        variable: anti_goals
        format: "comma-separated"

  - id: create_concept
    name: Create CONCEPT.md
    action: create_file
    path: docs/CONCEPT.md
    template: templates/CONCEPT.md
    variables:
      why: "{{ why_statement }}"
      vibe: "{{ vibe_keywords }}"
      anti_goals: "{{ anti_goals }}"

  - id: gather_architecture
    name: ENCODE - Gather Technical Blueprint
    action: prompt_user
    prompts:
      - question: "What is the Risk Grade? (L1=routine, L2=logic changes, L3=security)"
        variable: risk_grade
        options: ["L1", "L2", "L3"]
      - question: "What files will be created/modified? (file tree)"
        variable: file_tree
        format: "tree structure"
      - question: "What external dependencies are required? (justify each)"
        variable: dependencies
        format: "name: justification"

  - id: create_architecture
    name: Create ARCHITECTURE_PLAN.md
    action: create_file
    path: docs/ARCHITECTURE_PLAN.md
    template: templates/ARCHITECTURE_PLAN.md
    variables:
      risk_grade: "{{ risk_grade }}"
      file_tree: "{{ file_tree }}"
      dependencies: "{{ dependencies }}"

  - id: calculate_genesis_hash
    name: Calculate Genesis Hash
    action: compute_hash
    algorithm: SHA-256
    inputs:
      - docs/CONCEPT.md
      - docs/ARCHITECTURE_PLAN.md
    output: genesis_hash

  - id: create_ledger
    name: Initialize META_LEDGER.md
    action: create_file
    path: docs/META_LEDGER.md
    template: templates/META_LEDGER.md
    variables:
      genesis_hash: "{{ genesis_hash }}"
      timestamp: "{{ ISO_8601_NOW }}"
      risk_grade: "{{ risk_grade }}"

  - id: routing_decision
    name: Determine Next Action
    action: conditional
    conditions:
      - if: "{{ risk_grade }} == 'L1'"
        then:
          message: "DNA Seeded. Low risk. Proceed to /aegis-implement."
          next_workflow: aegis-implement
      - if: "{{ risk_grade }} == 'L2'"
        then:
          message: "DNA Seeded. Logic changes detected. Invoke /aegis-gate before implementation."
          next_workflow: aegis-gate
          required: true
      - if: "{{ risk_grade }} == 'L3'"
        then:
          message: "DNA Seeded. CRITICAL: Security path detected. /aegis-gate MANDATORY. Dataset LOCKED."
          next_workflow: aegis-gate
          required: true
          lock_dataset: true

  - id: final_report
    name: Generate Bootstrap Report
    action: output
    format: |
      ## Bootstrap Complete

      **Project**: {{ project_name | default('Unnamed') }}
      **Genesis Hash**: {{ genesis_hash[:8] }}...
      **Risk Grade**: {{ risk_grade }}
      **Lifecycle Stage**: ENCODED

      ### Created Artifacts
      - docs/CONCEPT.md ✓
      - docs/ARCHITECTURE_PLAN.md ✓
      - docs/META_LEDGER.md ✓

      ### Next Action
      {{ routing_decision.message }}

      ---
      *DNA Seeded. Dataset Locked. Auto-Router Active.*

postconditions:
  - name: verify_artifacts
    check: "all([docs/CONCEPT.md, docs/ARCHITECTURE_PLAN.md, docs/META_LEDGER.md])"
    expect: "exists"

error_handling:
  on_user_cancel:
    action: cleanup
    message: "Bootstrap cancelled. No artifacts created."
  on_file_error:
    action: rollback
    message: "File creation failed. Rolling back changes."
